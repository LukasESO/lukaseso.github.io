<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Livre Explorer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Configuração do Tailwind e desativação do aviso de console
        window.tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#e11d48',
                        dark: '#0f172a',
                        card: '#1e293b'
                    }
                }
            }
        };
        // Silencia o aviso específico do Tailwind no console
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn(...args);
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .manga-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1.5rem; }
        .reader-img { width: 100%; max-width: 800px; margin: 0 auto; display: block; }
        .loading-shimmer { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-dark/90 backdrop-blur-md border-b border-slate-800 p-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="showHome()">
                <div class="bg-brand p-1.5 rounded-lg">
                    <i data-lucide="book-open" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white hidden sm:block">MANGA<span class="text-brand">LIVRE</span></h1>
            </div>
            
            <div class="flex-1 max-w-md mx-4">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Buscar mangás..." 
                        class="w-full bg-slate-800 border-none rounded-full py-2 px-10 focus:ring-2 focus:ring-brand text-sm outline-none text-white">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button class="text-slate-400 hover:text-white transition"><i data-lucide="user" class="w-6 h-6"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6">
        <!-- Listagem Principal -->
        <div id="homeSection">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <i data-lucide="trending-up" class="text-brand"></i> Populares agora
            </h2>
            <div id="mangaList" class="manga-grid">
                <!-- Skeletons inseridos via JS -->
            </div>
        </div>

        <!-- Detalhes do Mangá -->
        <div id="detailsSection" class="hidden">
            <button onclick="showHome()" class="mb-6 flex items-center gap-2 text-slate-400 hover:text-brand transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i> Voltar
            </button>
            <div id="mangaDetailsContent"></div>
        </div>

        <!-- Leitor -->
        <div id="readerSection" class="hidden fixed inset-0 z-[60] bg-black overflow-y-auto no-scrollbar">
            <div class="sticky top-0 bg-black/90 backdrop-blur-md p-4 flex items-center justify-between border-b border-white/10">
                <div class="flex items-center gap-4">
                    <button onclick="closeReader()" class="p-2 hover:bg-white/10 rounded-full text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <h3 id="readerTitle" class="text-sm font-medium text-slate-300 truncate max-w-[150px] sm:max-w-md">Capítulo</h3>
                </div>
                <div class="flex gap-2">
                    <button id="prevCap" class="px-3 py-1.5 bg-white/10 rounded text-sm disabled:opacity-30">Anterior</button>
                    <button id="nextCap" class="px-3 py-1.5 bg-brand rounded text-sm disabled:opacity-30">Próximo</button>
                </div>
            </div>
            <div id="pagesContainer" class="flex flex-col items-center py-4 space-y-2">
                <!-- Imagens aqui -->
            </div>
        </div>
    </main>

    <script>
        const JIKAN_API = 'https://api.jikan.moe/v4';
        const MANGADEX_API = 'https://api.mangadex.org';
        // Proxy para contornar o bloqueio de CORS
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        
        let currentChapters = [];
        let currentChapterIndex = -1;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchTrending();
            
            const searchInput = document.getElementById('searchInput');
            searchInput.onkeypress = (e) => {
                if (e.key === 'Enter') searchManga(e.target.value);
            };
        });

        function showHome() {
            document.getElementById('homeSection').classList.remove('hidden');
            document.getElementById('detailsSection').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function showDetails() {
            document.getElementById('homeSection').classList.add('hidden');
            document.getElementById('detailsSection').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function closeReader() {
            document.getElementById('readerSection').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            document.getElementById('pagesContainer').innerHTML = '';
        }

        function createSkeletons() {
            const container = document.getElementById('mangaList');
            container.innerHTML = '';
            for(let i=0; i<12; i++) {
                const skel = document.createElement('div');
                skel.className = 'space-y-3';
                skel.innerHTML = `
                    <div class="aspect-[3/4] rounded-xl loading-shimmer"></div>
                    <div class="h-4 w-3/4 rounded loading-shimmer"></div>
                `;
                container.appendChild(skel);
            }
        }

        async function fetchTrending() {
            createSkeletons();
            try {
                const response = await fetch(`${JIKAN_API}/top/manga?filter=bypopularity&limit=20`);
                const data = await response.json();
                renderMangaList(data.data);
            } catch (err) {
                console.error(err);
                document.getElementById('mangaList').innerHTML = `<p class="text-red-500 text-center col-span-full py-10">Erro ao carregar mangás.</p>`;
            }
        }

        async function searchManga(query) {
            if (!query) return fetchTrending();
            const container = document.getElementById('mangaList');
            container.innerHTML = '<p class="col-span-full text-center py-10 text-slate-400">Buscando...</p>';
            
            try {
                const response = await fetch(`${JIKAN_API}/manga?q=${encodeURIComponent(query)}&order_by=popularity&sort=asc`);
                const data = await response.json();
                renderMangaList(data.data);
            } catch (err) {
                console.error(err);
            }
        }

        function renderMangaList(mangas) {
            const container = document.getElementById('mangaList');
            container.innerHTML = '';

            if (!mangas || mangas.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center py-10 text-slate-500">Nenhum resultado encontrado.</p>';
                return;
            }

            mangas.forEach(manga => {
                const card = document.createElement('div');
                card.className = 'group cursor-pointer transition-all hover:-translate-y-1';
                card.onclick = () => loadMangaDetails(manga.mal_id);
                
                card.innerHTML = `
                    <div class="relative aspect-[3/4] rounded-xl overflow-hidden shadow-lg border border-slate-800">
                        <img src="${manga.images.webp.large_image_url}" alt="${manga.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                        <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/90 to-transparent">
                            <span class="text-[10px] uppercase font-bold text-brand bg-brand/10 px-2 py-0.5 rounded">${manga.type || 'Manga'}</span>
                        </div>
                    </div>
                    <h3 class="mt-3 text-sm font-semibold line-clamp-2 group-hover:text-brand transition">${manga.title}</h3>
                    <p class="text-xs text-slate-500 mt-1">${manga.score ? '⭐ ' + manga.score : 'N/A'}</p>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        async function loadMangaDetails(malId) {
            showDetails();
            const content = document.getElementById('mangaDetailsContent');
            content.innerHTML = '<div class="h-96 loading-shimmer rounded-2xl w-full"></div>';

            try {
                const response = await fetch(`${JIKAN_API}/manga/${malId}/full`);
                const { data } = await response.json();
                
                content.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-72 shrink-0">
                            <img src="${data.images.webp.large_image_url}" class="w-full rounded-2xl shadow-2xl border border-slate-800">
                            <div class="mt-6 space-y-2 p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                                <div class="flex justify-between text-sm"><span class="text-slate-500">Status</span> <span class="text-white">${data.status}</span></div>
                                <div class="flex justify-between text-sm"><span class="text-slate-500">Capítulos</span> <span class="text-white">${data.chapters || '??'}</span></div>
                                <div class="flex justify-between text-sm"><span class="text-slate-500">Nota</span> <span class="text-brand font-bold">${data.score || 'N/A'}</span></div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-3xl font-bold mb-2">${data.title}</h2>
                            <p class="text-slate-400 mb-6 italic">${data.title_english || ''}</p>
                            
                            <div class="flex flex-wrap gap-2 mb-8">
                                ${data.genres.map(g => `<span class="bg-slate-800 text-xs px-3 py-1 rounded-full border border-slate-700">${g.name}</span>`).join('')}
                            </div>

                            <div class="mb-8">
                                <h4 class="text-lg font-bold mb-2 border-b border-slate-800 pb-2">Sinopse</h4>
                                <p class="text-slate-300 leading-relaxed text-sm">${data.synopsis || 'Sem descrição.'}</p>
                            </div>

                            <div>
                                <h4 class="text-lg font-bold mb-4 border-b border-slate-800 pb-2 flex justify-between items-center">
                                    Capítulos PT-BR
                                    <span class="text-[10px] text-slate-500 uppercase tracking-widest">MangaDex</span>
                                </h4>
                                <div id="chapterList" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                    <div class="col-span-full py-10 flex flex-col items-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand mb-2"></div>
                                        <p class="text-slate-500 text-sm italic">Buscando capítulos em português...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                fetchMangaDexChapters(data.title);
            } catch (err) {
                console.error(err);
                content.innerHTML = `<p class="text-red-500">Erro ao carregar detalhes.</p>`;
            }
        }

        async function fetchMangaDexChapters(title) {
            const listContainer = document.getElementById('chapterList');
            
            try {
                // Passo 1: Busca ID do Mangá (Usando Proxy apenas se o primeiro falhar, ou sempre para segurança no MangaDex)
                const searchUrl = `${MANGADEX_API}/manga?title=${encodeURIComponent(title)}&limit=1&includes[]=cover_art`;
                
                // Tentativa direta com fallback de Proxy para evitar o erro de bloqueio relatado
                let response;
                try {
                    response = await fetch(searchUrl);
                    if (!response.ok) throw new Error();
                } catch {
                    // Fallback para Proxy se o GitHub Pages/Localhost estiver bloqueado
                    response = await fetch(CORS_PROXY + searchUrl);
                }
                
                const searchData = await response.json();
                
                if (!searchData.data || searchData.data.length === 0) {
                    listContainer.innerHTML = '<p class="text-yellow-500 text-sm py-4">Nenhum capítulo encontrado nesta fonte.</p>';
                    return;
                }

                const mdId = searchData.data[0].id;

                // Passo 2: Busca capítulos PT-BR
                const chapUrl = `${MANGADEX_API}/manga/${mdId}/feed?translatedLanguage[]=pt-br&limit=500&order[chapter]=desc`;
                let chapResp;
                try {
                    chapResp = await fetch(chapUrl);
                    if (!chapResp.ok) throw new Error();
                } catch {
                    chapResp = await fetch(CORS_PROXY + chapUrl);
                }
                
                const chapData = await chapResp.json();

                if (!chapData.data || chapData.data.length === 0) {
                    listContainer.innerHTML = '<p class="text-yellow-500 text-sm py-4 italic">Conteúdo disponível em outros idiomas (PT-BR indisponível).</p>';
                    return;
                }

                currentChapters = chapData.data;
                listContainer.innerHTML = '';
                
                currentChapters.forEach((chap, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'flex items-center justify-between p-3 bg-slate-800/50 hover:bg-brand/20 border border-slate-700 rounded-lg text-left transition group';
                    btn.onclick = () => openChapter(index);
                    
                    const num = chap.attributes.chapter || '?';
                    const cTitle = chap.attributes.title || `Capítulo ${num}`;
                    
                    btn.innerHTML = `
                        <div class="flex flex-col overflow-hidden">
                            <span class="text-xs text-brand font-bold uppercase">Cap. ${num}</span>
                            <span class="text-sm text-slate-200 truncate pr-4">${cTitle}</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-500 group-hover:text-brand shrink-0"></i>
                    `;
                    listContainer.appendChild(btn);
                });
                lucide.createIcons();

            } catch (err) {
                console.error('Erro na integração MangaDex:', err);
                listContainer.innerHTML = `
                    <div class="col-span-full py-4 text-center">
                        <p class="text-red-500 text-sm mb-2">Erro de conexão com o servidor de capítulos.</p>
                        <p class="text-xs text-slate-500 px-4">Nota: O MangaDex bloqueia requisições de domínios específicos. Tente recarregar ou use um navegador com CORS liberado.</p>
                    </div>
                `;
            }
        }

        async function openChapter(index) {
            currentChapterIndex = index;
            const chapter = currentChapters[index];
            
            document.getElementById('readerSection').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('readerTitle').innerText = `Cap. ${chapter.attributes.chapter} - ${chapter.attributes.title || ''}`;
            
            const pagesContainer = document.getElementById('pagesContainer');
            pagesContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-screen text-slate-500">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand mb-4"></div>
                    <p>Carregando páginas...</p>
                </div>
            `;

            try {
                const serverUrl = `${MANGADEX_API}/at-home/server/${chapter.id}`;
                let serverResp;
                try {
                    serverResp = await fetch(serverUrl);
                    if (!serverResp.ok) throw new Error();
                } catch {
                    serverResp = await fetch(CORS_PROXY + serverUrl);
                }
                
                const serverData = await serverResp.json();
                const hash = serverData.chapter.hash;
                const images = serverData.chapter.data; 
                const baseUrl = serverData.baseUrl;

                pagesContainer.innerHTML = '';
                
                images.forEach(imgName => {
                    const img = document.createElement('img');
                    img.className = 'reader-img opacity-0 transition-opacity duration-300';
                    // As imagens do MangaDex At Home geralmente não precisam de proxy se o baseUrl for o servidor deles
                    img.src = `${baseUrl}/data/${hash}/${imgName}`;
                    img.loading = 'lazy';
                    img.onerror = () => {
                         // Fallback para Proxy em caso de erro na imagem individual
                         img.src = CORS_PROXY + `${baseUrl}/data/${hash}/${imgName}`;
                    };
                    img.onload = () => img.classList.remove('opacity-0');
                    pagesContainer.appendChild(img);
                });

                document.getElementById('prevCap').disabled = index >= currentChapters.length - 1;
                document.getElementById('nextCap').disabled = index <= 0;
                
                document.getElementById('prevCap').onclick = () => openChapter(index + 1);
                document.getElementById('nextCap').onclick = () => openChapter(index - 1);
                
                document.getElementById('readerSection').scrollTo(0,0);

            } catch (err) {
                console.error(err);
                pagesContainer.innerHTML = '<p class="text-red-500 p-10">Não foi possível carregar as imagens deste capítulo.</p>';
            }
        }
    </script>
</body>
</html>
