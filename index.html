<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangaLibre - Mangás, Manhwas & Webtoons</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f10;
            --card-dark: #1a1a1c;
            --accent: #e50914;
        }
        body {
            background-color: var(--bg-dark);
            color: #efefef;
            font-family: 'Inter', sans-serif;
        }
        .manga-card:hover .overlay {
            opacity: 1;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a1c;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .nav-link {
            @apply hover:text-white transition cursor-pointer text-gray-400 text-sm font-medium border-b-2 border-transparent pb-1;
        }
        .nav-link.active {
            @apply text-red-600 border-red-600;
        }
        .filter-chip {
            @apply px-3 py-1.5 rounded-full text-xs font-medium bg-[#1a1a1c] border border-gray-800 hover:border-red-600 hover:text-white transition cursor-pointer whitespace-nowrap;
        }
        .filter-chip.active {
            @apply bg-red-600 border-red-600 text-white;
        }
        .pagination-btn {
            @apply bg-[#1a1a1c] border border-gray-800 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-600 hover:border-red-600 transition disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-2;
        }
        .chapter-list-item {
            @apply flex justify-between items-center p-3 border-b border-white/5 hover:bg-white/5 transition cursor-pointer rounded-lg;
        }
    </style>
</head>
<body class="custom-scrollbar">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-[#121214] border-b border-gray-800 px-4 py-3">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-8">
                <h1 class="text-2xl font-bold text-red-600 tracking-tighter cursor-pointer" onclick="resetAndLoad()">
                    MANGA<span class="text-white">LIBRE</span>
                </h1>
                <div class="hidden lg:flex gap-6">
                    <span onclick="setFilter('trending')" class="nav-link active" id="nav-trending">Início</span>
                    <span onclick="setFilter('popular')" class="nav-link" id="nav-popular">Populares</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="relative hidden sm:block">
                    <form id="search-form" onsubmit="handleSearch(event)">
                        <input type="text" id="search-input" placeholder="Buscar título no MangaDex..." class="bg-[#1a1a1c] border border-gray-700 rounded-full px-4 py-1.5 text-sm focus:outline-none focus:border-red-600 w-48 md:w-64 transition-all text-white">
                        <button type="submit" class="absolute right-3 top-2.5 text-gray-500 hover:text-red-600">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>
                <button class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded text-sm font-bold transition">Login</button>
            </div>
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <main id="home-page" class="max-w-7xl mx-auto p-4 sm:p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 id="section-title" class="text-xl font-bold flex items-center gap-2 text-white">
                <span class="w-1 h-6 bg-red-600 rounded-full"></span>
                Explorar Mangás
            </h3>
        </div>
        <div id="error-message" class="hidden bg-red-900/20 border border-red-900/50 text-red-500 p-4 rounded-lg mb-6 text-center">
            Ocorreu um erro ao carregar os dados da API. Tentando novamente em instantes...
        </div>
        <div id="loader" class="hidden flex justify-center py-20">
            <div class="loading-spinner"></div>
        </div>
        <div id="manga-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        
        <!-- Paginação -->
        <div id="pagination-controls" class="flex items-center justify-center gap-4 mt-12 py-6 border-t border-white/5">
            <button id="prev-btn" onclick="changePage(-1)" class="pagination-btn"><i class="fas fa-chevron-left"></i> Anterior</button>
            <span id="page-indicator" class="text-sm font-bold text-gray-400 bg-white/5 px-4 py-2 rounded-lg">Página 1</span>
            <button id="next-btn" onclick="changePage(1)" class="pagination-btn">Próximo <i class="fas fa-chevron-right"></i></button>
        </div>
    </main>

    <!-- Detalhes do Mangá -->
    <main id="details-page" class="hidden max-w-7xl mx-auto p-4 sm:p-6">
        <button onclick="showPage('home')" class="mb-6 text-gray-400 hover:text-white transition flex items-center gap-2">
            <i class="fas fa-arrow-left"></i> Voltar
        </button>
        <div id="manga-detail-content"></div>
    </main>

    <!-- Visualizador de Leitura -->
    <main id="reader-page" class="hidden bg-black min-h-screen">
        <div class="sticky top-0 z-50 bg-[#121214] p-4 flex justify-between items-center border-b border-white/10">
            <button onclick="showPage('details')" class="text-white bg-white/10 px-4 py-2 rounded-lg text-sm hover:bg-white/20 transition">
                <i class="fas fa-times"></i> Fechar Leitor
            </button>
            <h4 id="reader-title" class="text-sm font-bold truncate max-w-xs md:max-w-lg">Lendo Capítulo</h4>
            <div class="w-10"></div>
        </div>
        <div id="reader-images" class="flex flex-col items-center gap-4 py-6 max-w-4xl mx-auto"></div>
        <div class="p-10 text-center">
            <p class="text-gray-500 text-sm">Fim do Capítulo</p>
        </div>
    </main>

    <script>
        // Configurações de API - Utilizando uma instância Vercel ou Fallback se api.consumet.org falhar
        const JIKAN_API = 'https://api.jikan.moe/v4';
        
        // Tentamos usar instâncias alternativas caso a principal falhe
        const CONSUMET_INSTANCES = [
            'https://consumet-api-production-e652.up.railway.app/manga/mangadex',
            'https://api-consumet-org-instance.vercel.app/manga/mangadex',
            'https://api.consumet.org/manga/mangadex'
        ];
        
        let currentInstanceIndex = 0;
        let currentFilter = 'trending';
        let currentPage = 1;
        let isFetching = false;

        async function handleSearch(event) {
            event.preventDefault();
            const query = document.getElementById('search-input').value;
            if (query.length < 3) return;
            showPage('home');
            currentPage = 1;
            document.getElementById('section-title').innerText = `Resultados para: ${query}`;
            const data = await fetchFromConsumet(`/${encodeURIComponent(query)}?page=${currentPage}`);
            if (data && data.results) renderGrid(data.results);
        }

        async function fetchFromConsumet(endpoint) {
            if (isFetching) return null;
            isFetching = true;
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('error-message').classList.add('hidden');

            // Tentativa com Retry e troca de instância
            for (let i = 0; i < CONSUMET_INSTANCES.length; i++) {
                try {
                    const baseUrl = CONSUMET_INSTANCES[currentInstanceIndex];
                    const response = await fetch(`${baseUrl}${endpoint}`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error('Falha na resposta da rede');
                    
                    const result = await response.json();
                    isFetching = false;
                    document.getElementById('loader').classList.add('hidden');
                    return result;
                } catch (e) {
                    console.warn(`Instância ${currentInstanceIndex} falhou. Tentando próxima...`);
                    currentInstanceIndex = (currentInstanceIndex + 1) % CONSUMET_INSTANCES.length;
                }
            }

            // Se todas falharem
            isFetching = false;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('error-message').classList.remove('hidden');
            return null;
        }

        async function fetchFromJikan(endpoint) {
            try {
                const response = await fetch(`${JIKAN_API}${endpoint}`);
                const result = await response.json();
                return result.data;
            } catch (e) {
                console.error("Erro Jikan:", e);
                return null;
            }
        }

        async function loadContent() {
            showPage('home');
            let endpoint = `/${currentFilter}?page=${currentPage}`;
            const data = await fetchFromConsumet(endpoint);
            
            if (data && data.results) {
                renderGrid(data.results);
                updatePaginationUI(data.hasNextPage || false);
            }
        }

        function renderGrid(list) {
            const grid = document.getElementById('manga-grid');
            if (list.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">Nenhum resultado encontrado.</p>';
                return;
            }
            grid.innerHTML = list.map(item => `
                <div class="manga-card relative group cursor-pointer" onclick="openDetails('${item.id}')">
                    <div class="relative overflow-hidden rounded-xl aspect-[3/4] bg-[#1a1a1c] shadow-lg">
                        <img src="${item.image}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" alt="${item.title}" onerror="this.src='https://via.placeholder.com/300x450?text=Sem+Imagem'">
                        <div class="overlay absolute inset-0 bg-black/60 opacity-0 transition-opacity flex flex-col justify-end p-4">
                             <button class="bg-red-600 text-[10px] py-2 rounded font-bold uppercase">Ler Agora</button>
                        </div>
                    </div>
                    <p class="mt-2 text-sm font-bold truncate">${typeof item.title === 'object' ? item.title.en || item.title.ja || item.title.it : item.title}</p>
                </div>
            `).join('');
        }

        async function openDetails(mangaId) {
            showPage('details');
            const container = document.getElementById('manga-detail-content');
            container.innerHTML = '<div class="flex justify-center p-20"><div class="loading-spinner"></div></div>';
            
            const mangaData = await fetchFromConsumet(`/info/${mangaId}`);
            if (!mangaData) {
                container.innerHTML = '<p class="text-center py-20 text-red-500">Erro ao carregar detalhes. Tente outra vez.</p>';
                return;
            }

            const titleText = typeof mangaData.title === 'object' ? mangaData.title.en || mangaData.title.ja || mangaData.title.it : mangaData.title;
            
            // Jikan para sinopse
            const jikanData = await fetchFromJikan(`/manga?q=${encodeURIComponent(titleText)}&limit=1`);
            const extraInfo = jikanData && jikanData.length > 0 ? jikanData[0] : null;

            container.innerHTML = `
                <div class="flex flex-col md:flex-row gap-8 text-left">
                    <div class="w-full md:w-1/3 max-w-[300px] mx-auto">
                        <img src="${mangaData.image}" class="rounded-xl shadow-xl w-full" alt="${titleText}">
                    </div>
                    <div class="flex-1">
                        <h2 class="text-3xl font-black mb-2">${titleText}</h2>
                        <p class="text-gray-400 mb-4 italic">${mangaData.altTitles?.length > 0 ? mangaData.altTitles[0] : ''}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-6">
                            ${(extraInfo?.genres || mangaData.genres || []).map(g => `<span class="bg-white/5 px-3 py-1 rounded-full text-xs">${g.name || g}</span>`).join('')}
                        </div>

                        <h4 class="font-bold mb-2">Sinopse</h4>
                        <div class="text-gray-400 text-sm mb-8 leading-relaxed max-h-48 overflow-y-auto custom-scrollbar">
                            ${extraInfo?.synopsis || mangaData.description?.en || mangaData.description || 'Descrição não disponível.'}
                        </div>
                        
                        <div class="bg-[#1a1a1c] p-6 rounded-xl">
                            <h4 class="text-lg font-bold mb-4 flex items-center justify-between">
                                Capítulos Disponíveis
                                <span class="text-[10px] text-gray-500 font-normal">MangaDex</span>
                            </h4>
                            <div id="chapters-list" class="flex flex-col gap-1 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                                ${mangaData.chapters && mangaData.chapters.length > 0 ? 
                                    mangaData.chapters.map(ch => `
                                        <div class="chapter-list-item" onclick="openChapter('${ch.id}', 'Cap. ${ch.chapterNumber} - ${ch.title || ''}')">
                                            <div>
                                                <span class="font-bold text-white">Capítulo ${ch.chapterNumber}</span>
                                                <span class="text-[10px] text-gray-500 ml-2 uppercase">${ch.title ? ch.title : ''}</span>
                                            </div>
                                            <i class="fas fa-book-open text-red-600 text-xs"></i>
                                        </div>
                                    `).reverse().join('') : 
                                    '<p class="text-gray-500 italic">Nenhum capítulo encontrado nesta língua.</p>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function openChapter(chapterId, title) {
            showPage('reader');
            document.getElementById('reader-title').innerText = title;
            const container = document.getElementById('reader-images');
            container.innerHTML = '<div class="flex flex-col items-center gap-4 mt-20"><div class="loading-spinner"></div><p class="text-sm text-gray-500">Carregando páginas...</p></div>';

            try {
                // Algumas instâncias da Consumet exigem /read/ outros /view/
                const response = await fetch(`${CONSUMET_INSTANCES[currentInstanceIndex]}/read/${chapterId}`);
                const pages = await response.json();

                if (!pages || pages.length === 0) throw new Error('Nenhuma página retornada');

                container.innerHTML = pages.map(page => `
                    <img src="${page.img}" 
                         class="w-full max-w-3xl shadow-2xl bg-[#1a1a1c] mb-2" 
                         loading="lazy"
                         referrerpolicy="no-referrer"
                         onerror="this.src='https://via.placeholder.com/800x1200?text=Erro+ao+Carregar+Página';">
                `).join('');

            } catch (err) {
                container.innerHTML = '<div class="text-center mt-20"><p class="text-red-500 mb-4">Não foi possível carregar as imagens deste capítulo.</p><button onclick="showPage(\'details\')" class="bg-white/10 px-6 py-2 rounded">Voltar</button></div>';
            }
        }

        function showPage(pageId) {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('details-page').classList.add('hidden');
            document.getElementById('reader-page').classList.add('hidden');
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updatePaginationUI(hasNext) {
            document.getElementById('page-indicator').innerText = `Página ${currentPage}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = !hasNext;
        }

        function changePage(delta) {
            currentPage += delta;
            loadContent();
        }

        function setFilter(filter) {
            currentFilter = filter;
            currentPage = 1;
            const links = document.querySelectorAll('.nav-link');
            links.forEach(l => l.classList.remove('active'));
            const activeLink = document.getElementById(`nav-${filter}`);
            if (activeLink) activeLink.classList.add('active');
            
            const titles = { 'trending': 'Tendências', 'popular': 'Mais Populares' };
            document.getElementById('section-title').innerText = titles[filter] || 'Explorar';
            
            loadContent();
        }

        function resetAndLoad() {
            currentPage = 1;
            currentFilter = 'trending';
            loadContent();
        }

        window.onload = loadContent;
    </script>
</body>
</html>
